<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>
        var ws = new WebSocket("ws://localhost:8080/player");
        var playerId;
        ws.onopen = function (event) {

        };
        ws.onmessage = function (event) {
            if (event.data.startsWith('id=')) {
                playerId = event.data.substring(3);
                return;
            }
            drawGame($.parseJSON(event.data));

        };

        $(document).ready(function () {
            $("#fetch_games").click(function () {
                $.get("api/game",
                    function (response) {
                        //             response = $.parseJSON(response);
                        $(function () {
                            $("#records_table").empty();
                            $.each(response, function (i, game) {
                                var $tr = $('<tr>').append(
                                    $('<td>').text(game.id),
                                    $('<td>').text(game.tickCount),
                                    $('<td>').append($('<button>').click(function () {
                                        let spectatorDto = {"playerId": playerId};
                                        $.ajax({
                                            url: "/api/game/" + game.id + "/spectate/",
                                            type: "POST",
                                            data: JSON.stringify(spectatorDto),
                                            contentType: "application/json; charset=utf-8",
                                            dataType: "json",
                                            success: function (response) {
                                                drawGame(JSON.parse(JSON.stringify(response)));
                                            }
                                        })

                                    }).text("Watch"))
                                ).appendTo('#records_table');
                            });
                        });
                    });
            });

            $("#start_ai_game").click(function () {
                $.post("api/game/ai",
                    function (response) {

                        let spectatorDto = {"playerId": playerId};
                        // $.post("/api/game/" + response.id + "/spectate/", JSON.stringify(spectatorDto),
                        //     function (spectateResponse) {
                        //         console.log(spectateResponse);
                        //     });

                        $.ajax({
                            url: "/api/game/" + response.id + "/spectate/",
                            type: "POST",
                            data: JSON.stringify(spectatorDto),
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function (spectateResponse) {
                                //console.log(spectateResponse);
                            }
                        })
                    }
                );
            });

            $("#play_single_player_game").click(function () {
                $.post("api/game/singleplayer/" + playerId,
                    function (response) {
                    });
            });
        });

        function drawGame(game) {

            let x;
            let y;
            $('#playing_field').empty();
            for (y = 99; y >= 0; y--) {
                for (x = 0; x < 100; x++) {
                    if (game.playingField[x][y] === 0) {
                        $('#playing_field').append(" ")
                    } else if (game.playingField[x][y] === 1) {
                        if (game.player1.positionX === x && game.player1.positionY === y) {
                            $('#playing_field').append("#")
                        } else {
                            $('#playing_field').append("+")
                        }
                    } else if (game.playingField[x][y] === 2) {
                        if (game.player2.positionX === x && game.player2.positionY === y) {
                            $('#playing_field').append("@")
                        } else {
                            $('#playing_field').append("x")
                        }
                    }

                    $('#status').text(game.winner);
                    if (game.status == "COMPLETED_WINNER") {

                    }
                }
                $('#playing_field').append("\n");
            }
        }

        $(document).keypress(function (e) {
                if (e.key === "w") {
                    ws.send("UP");
                } else if (e.key === "s") {
                    ws.send("DOWN");
                } else if (e.key === "a") {
                    ws.send("LEFT");
                } else if (e.key === "d") {
                    ws.send("RIGHT");
                } else if (e.key === "r") {
                    ws.send("READY");
                }
            }
        );

    </script>
    <style>
        .playing_field {
            font-family: "Courier New", Courier, monospace;
            font-size: 8px;
            line-height: 7px;
        }
    </style>
</head>
<body>
<pre id="playing_field" class="playing_field"></pre>
<p id="status"></p>
<button type="button" id="play_single_player_game">Single Player Game</button>
<button type="button" id="start_ai_game">Start AI Battle</button>
<button type="button" id="fetch_games">Fetch Games</button>
<table id="records_table"></table>
</body>
</html>