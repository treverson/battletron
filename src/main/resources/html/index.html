<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>
        var ws = new WebSocket("ws://localhost:8080/player");
        var playerId;
        ws.onopen = function (event) {

        };
        ws.onmessage = function (event) {
            if (event.data.startsWith('id=')) {
                playerId = event.data.substring(3);
                return;
            }
            drawGame($.parseJSON(event.data));

        };

        $(document).ready(function () {
            $("#fetch_games").click(function () {
                $.get("api/game",
                    function (response) {
                        //             response = $.parseJSON(response);
                        $(function () {
                            $("#records_table").empty();
                            $.each(response, function (i, game) {
                                var $tr = $('<tr>').append(
                                    $('<td>').text(game.id),
                                    $('<td>').text(game.tickCount),
                                    $('<td>').append($('<button>').click(function () {
                                        let spectatorDto = {"playerId": playerId};
                                        $.ajax({
                                            url: "/api/game/" + game.id + "/spectate/",
                                            type: "POST",
                                            data: JSON.stringify(spectatorDto),
                                            contentType: "application/json; charset=utf-8",
                                            dataType: "json",
                                            success: function (response) {
                                                drawGame(JSON.parse(JSON.stringify(response)));
                                            }
                                        })

                                    }).text("Watch"))
                                ).appendTo('#records_table');
                            });
                        });
                    });
            });

            $("#start_ai_game").click(function () {
                let newGameDto = {
                    "playerId": playerId,
                    "player1Type": "simpleAi",
                    "player2Type": "downLeftAi"
                };

                $.ajax({
                    url: "/api/game/",
                    type: "POST",
                    data: JSON.stringify(newGameDto),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        console.log(response);
                    }
                })
            });

            $("#play_single_player_game").click(function () {
                let newGameDto = {
                    "playerId": playerId,
                    "player1Type": "W-A-S-D",
                    "player2Type": "simpleAi"
                };

                $.ajax({
                    url: "/api/game/",
                    type: "POST",
                    data: JSON.stringify(newGameDto),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        console.log(response);
                    }
                })
            });

            $("#play_two_player_game").click(function () {
                let newGameDto = {
                    "playerId": playerId,
                    "player1Type": "W-A-S-D",
                    "player2Type": "arrowKeys"
                };

                $.ajax({
                    url: "/api/game/",
                    type: "POST",
                    data: JSON.stringify(newGameDto),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        console.log(response);
                    }
                })
            });
        });

        function drawGame(game) {

            let x;
            let y;
            $('#playing_field').empty();
            for (y = 99; y >= 0; y--) {
                for (x = 0; x < 100; x++) {
                    if (game.playingField[x][y] === 0) {
                        $('#playing_field').append(" ")
                    } else if (game.playingField[x][y] === 1) {
                        if (game.player1.positionX === x && game.player1.positionY === y) {
                            $('#playing_field').append("#")
                        } else {
                            $('#playing_field').append("+")
                        }
                    } else if (game.playingField[x][y] === 2) {
                        if (game.player2.positionX === x && game.player2.positionY === y) {
                            $('#playing_field').append("@")
                        } else {
                            $('#playing_field').append("x")
                        }
                    }

                    $('#status').text(game.winner);
                    if (game.status == "COMPLETED_WINNER") {

                    }
                }
                $('#playing_field').append("\n");
            }
        }

        $(document).on("keydown", (function (e) {
                let key = e.which;

                if (key === 87) {
                    ws.send("W");
                } else if (key === 83) {
                    ws.send("S");
                } else if (key === 65) {
                    ws.send("A");
                } else if (key === 68) {
                    ws.send("D");
                } else if (key === 38) {
                    ws.send("UP");
                } else if (key === 40) {
                    ws.send("DOWN");
                } else if (key === 37) {
                    ws.send("LEFT");
                } else if (key === 39) {
                    ws.send("RIGHT");
                }
            })
        );

    </script>
    <style>
        .playing_field {
            font-family: "Courier New", Courier, monospace;
            font-size: 8px;
            line-height: 7px;
        }
    </style>
</head>
<body>
<pre id="playing_field" class="playing_field"></pre>
<p id="status"></p>
<button type="button" id="play_single_player_game">Single Player Game</button>
<button type="button" id="play_two_player_game">Two Player Game</button>
<button type="button" id="start_ai_game">Start AI Battle</button>
<button type="button" id="fetch_games">Fetch Games</button>
<table id="records_table"></table>
</body>
</html>